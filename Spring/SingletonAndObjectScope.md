# 싱글톤 레지스트리와 오브젝트 스코프

## 1. 개요

팩토리 클래스를 직접 사용하는 것과 @Configuration 애노테이션을 추가해서 스프링의 애플리케이션 컨텍스트를 사용하는 것은 테스트 결과로만 보면 동일한 것 같다.
하지만 그렇지 않다.

```java
DaoFactory factory = new DaoFactory();
UserDao dao1 = factory.userDao();
UserDao dao2 = factory.userDao();
```

코드를 보면 매번 userDao 메서드를 호출할 때마다, new 연산자에 의해 새로운 오브젝트가 만들어진다.
즉 dao1 와 dao2 는 **서로 동일하지 않은 오브젝트**이다.

```java
ApplicationContext context = new AnnotationConfigApplicationContext(DaoFactory.class);
UserDao dao1 = context.getBean("userDao", UserDao.class);
UserDao dao2 = context.getBean("userDao", UserDao.class);
```

하지만 ApplicationContext 의 getBean 메서드를 이용하면 dao1 과 dao2 오브젝트는 **서로 동일**하다.
동일하기 때문에, dao1 == dao2 를 출력해보면 당연히 true 가 나온다.
애플리케이션 컨텍스트를 이용하면 매번 동일한 오브젝트를 리턴하는데 이유가 무엇일까?

### 1.1 싱글톤 레지스트리로서의 애플리케이션 컨텍스트

애플리케이션 컨텍스트는 싱글톤을 저장하고 관리하는 **싱글톤 레지스트리**이다.
스프링은 기본적으로 별다른 설정을 하지 않으면 내부적으로 생성하는 빈 오브젝트를 모두 **싱글톤**으로 만든다.
주의해야할 점은 디자인 패턴 중 하나인 싱글톤 패턴과는 구현이 다르다는 점이다.

> 이유

스프링이 주로 적용되는 대상은 자바 엔터프라이즈 기술을 사용하는 서버환경이다.
서버환경에서 매번 클라이언트 요청이 들어올 때마다 오브젝트를 생성한다면 그만큼 서버에 부하가 걸릴 수 밖에 없기 때문이다.

#### 1.1.1 싱글톤 디자인 패턴의 한계

싱글톤 패턴의 문제점은 다음과 같다.

- **private 생성자를 가지고 있기 때문에 상속이 불가능하다.**

private 생성자를 가진 클래스는 다른 생성자가 없다면 상속이 불가능하다.
즉, 객체 지향의 장점인 상속과 이를 이용한 다형성을 이용할 수 없다.
그리고 상속과 다형성 같은 객체 지향적인 특징이 적용되지 않는 **스태틱 필드와 메서드**를 사용한다는 것도 역시 문제이다.

- **싱글톤은 테스트하기 어렵다.**

싱글톤이 만들어지는 방식은 제한적이기 때문에 테스트에서 사용될 목 오브젝트 등으로 대체하기가 힘들다.
싱글톤은 초기화 과정에서 생성자 등을 통해 사용할 오브젝트를 동적으로 주입하기도 힘들기 때문에 필요한 오브젝트는 직접 생성해야 한다.
이런 경우 테스트용 오브젝트로 대체하기가 힘들다.

- **서버 환경에서 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.**

서버에서 클래스 로더를 어떻게 구성하고 있느냐에 따라서 싱글톤 클래스임에도 하나 이상의 오브젝트가 만들어질 수 있다.
여러 개의 JVM에 분산돼서 설치되는 경우에도 각각 독립적으로 싱글톤 오브젝트가 생기기 때문에 싱글톤으로서의 가치가 떨어진다.

- **싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다.**

싱글톤은 스태틱 메서드를 이용해 누구나 자유롭게 접근할 수 있다.
그러다보면 자연스럽게 **전역 상턔**로 사용되기 쉬운데, 이는 객체 지향 프로그래밍에서는 권장되지 않는 프로그래밍 모델이다.

### 1.2 싱글톤 레지스트리

자바의 싱글톤 패턴은 여러가지 단점이 있기 때문에 스프링은 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공한다.
이것이 바로 **싱글톤 레지스트리**이다. 이러한 싱글톤 레지스트리 덕분에 싱글톤 방식으로 사용될 클래스라도 public 생성자를 가질 수 있다.

#### 1.2.1 싱글톤과 오브젝트의 상태

싱글톤은 멀티 쓰레드 환경이라면 여러 쓰레드가 동시에 접근해서 사용할 수 있다.
따라서 상태 관리에 주의를 기울여야 한다. 따라서 싱글톤은 상태 정보를 내부에 갖고 있지 않는 **무상태(stateless)** 방식으로 만들어야 한다.

- 무상태로 클래스를 설계하는 방법
    - 파라미터
    - 로컬변수
    - 리턴 값

메서드 파라미터나 로컬 변수는 매번 새로운 값을 생성할 독립적인 공간을 만들기 때문에 싱글톤이라고 해도 쓰레드가 변수의 값을 덮어 쓸 일은 없다.

### 1.3 스프링 빈의 스코프

> 스프링 빈이 생성되고, 존재하고, 적용되는 범위를 빈의 스코프라고 한다.

스프링 빈의 기본 스코프는 싱글톤이다. 하지만 경우에 따라 싱글톤 외의 다양한 방식의 스코프를 가질 수도 있다.
대표적으로 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 생성하는 프로토타입 스코프가 있다.
그 외에도 웹을 통해 새로은 HTTP 요청이 올 때 생성되는 요청 스코프가 있고, 웹의 세션과 비슷한 세션 스코프도 있다.

### 2. 출처

> 토비의 스프링 1권